---
title: "Power Analysis for mixed models"
date: Last compiled on `r format(Sys.time(), '%B-%d-%Y')`
output: html_document
bibliography: references.bib
---

```{=html}
<style>
body {
text-align: justify}
</style>
```

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

We estimated power analyses for linear mixed models[@kumle2021; @pargent2024tutorial]. Since this study uses 2 types of dependent variables (likert-5 scales and likert 7-scales), two power analyses were performed for each type. Each power analysis is simulated using the mixed power package [@kumle2021]. This form of power analysis estimates how many times a result is significant compared to the amount of simulations for each sample size: $$power_n = \frac{\text{significant simulation}}{\text{total simulations}}$$ , where n is the sample size on which the simulations are ran and results are significant with an $\alpha = 0.05$ . For this study, we simulate power for 100, 200, 300 and 400 participants. While we aim to include approximately 400 participants, we want to know from which sample size onwards our models will be sufficiently powered (power $\ge$ 0.8).

Additionally, the likert 7-scales are used for the dependent variables of the construct Attributions and Stability, which will be estimated using OLS-regression. However, as we explore the variability between higher and lower performing students, a power analysis was conducted to test whether exploratory analyses would be sufficiently powered.

```{r}
rm(list = ls())
```

## Load UDF

```{r}

# This function is a confirmation for running lengthy simulations
Sim_Confirmation <- function() {
  user_input <- readline("Are you sure you want to run this? (y/n)  ")
  if(user_input != 'y') stop('Exiting since you did not press y')
  print('Good luck')
}

# This function creates the artificial_lmer and the Power Analysis in Mixed power
run_sim <- function(df = "Simulated df",
                    formula = "Regression Formula",
                    fixef = "Fixed effects",
                    ranef = "Random effects",
                    SESOI = "Smallest effect size of interest", 
                    fixef_name = "(Vector of) fixed effect-names",
                    var_name = "Name of simulated variable (subjects)",
                    sub_range = "Vector with sample sizes",
                    sim_n = 1000,
                    name = "Art_Model_id."){
  
  #---- Dependencies ----
  require(mixedpower)
  require(lme4)
  
  #---- Define regression formula ----
  formula <- formula
  
  #---- Define Mixed model ----
  articifial_lmer <- makeLmer(formula, fixef = fixef,
                              VarCorr = ranef,
                              data = df)
  
  assign(paste0(name, sample(c(1:999), 1)), articifial_lmer, .GlobalEnv)
  #---- Run simulations for artificial mixed model----
  # Warning: This is the part that takes a long time.
  # Mixedpower automatically paralellizes simulations, so executing is computationally intensive
  # Mixed power default uses all available cores -1, add argument "maxCores" if wanted
  t1 <- Sys.time()
  
  power <- mixedpower(model = articifial_lmer,
                      data = df,
                      fixed_effects = fixef_name,
                      simvar = var_name, steps = sub_range,
                      critical_value = 2,
                      n_sim = sim_n,
                      SESOI = SESOI)
  
  t2 <- Sys.time()
  
  print(t2-t1)
  return(power)
}
```

## Load libraries

```{r}
# install.packages(pacman)
library(pacman)

p_load(tidyverse,
       readxl,
       lme4,
       lmerTest,
       nlme,
       simr,
       mixedpower,
       future) #Add additional packages

```

# Load data template

```{r, echo = TRUE, results = "hide"}
setwd("simulations/") # Change WD for loading files
temp <- list.files(pattern = "\\.RData") # Load all .RData files in folder 

lapply(temp, load, .GlobalEnv)

```

## Simulation-based Power Analysis

### Regression formula

```{r}

formula <- Y ~ Condition*Contrast + (1 | Subject)

```

### Selection of simulated sample sizes

```{r}

sample_n <- c(100, 200, 300, 400)

```

### Effect Sizes & Variance Composition

#### Likert 5 scales

##### Fixed Effects

```{r}

#---- FIXED EFFECTS (small effects) ----
fixef_15 <- c(
  "(Intercept)"        = 3.0,   # midpoint of 1–5 scale
  "Condition"          = 0.23,  # small effect
  "Contrast"           = 0.17,  # small effect
  "Condition:Contrast" = 0.14   # small interaction
)

#---- Smallest Effect Size of interest ----
# 15 percent lower than fixed effects
fixef_15_SESOI <- c(
  "(Intercept)"        = 3.0,   # midpoint of 1–5 scale
  "Condition"          = 0.20,  # small effect
  "Contrast"           = 0.15,  # small effect
  "Condition:Contrast" = 0.12   # small interaction
)

```

##### Random Effects

```{r}
## AI was consulted for code & suggestions effect sizes
#---- RANDOM EFFECTS ----
sd_subject_intercept <- 0.6      # typical for Likert 1–5

# Variance-covariance matrix for random intercept only
rand_cov_15 <- matrix(sd_subject_intercept^2, nrow=1)
rownames(rand_cov_15) <- colnames(rand_cov_15) <- "(Intercept)"

# Residual variance
sd_residual <- 0.9

# Variance list
Var_15 <- list(Subject = rand_cov_15,
               Residual = sd_residual^2)

```

#### Likert 7 scales

##### Fixed Effects

```{r}

#---- FIXED EFFECTS (small effects) ----
fixef_17 <- c(
  "(Intercept)"        = 4.0,   # midpoint of 1–7 scale
  "Condition"          = 0.29,  # small effect
  "Contrast"           = 0.23,  # small effect
  "Condition:Contrast" = 0.17   # small interaction
)

#---- Smallest Effect Size of interest ----
# 15 percent lower than fixed effects
fixef_17_SESOI <- c(
  "(Intercept)"        = 4.0,   # midpoint of 1–7 scale
  "Condition"          = 0.25,  # small effect
  "Contrast"           = 0.20,  # small effect
  "Condition:Contrast" = 0.15   # small interaction
)

```

##### Random Effects

```{r}

## AI was consulted for code & suggestions effect sizes
#---- RANDOM EFFECTS ----
sd_subject_intercept <- 1.0      # typical for Likert 1–7

# Variance-covariance matrix for random intercept only
rand_cov_17 <- matrix(sd_subject_intercept^2, nrow=1)
rownames(rand_cov_17) <- colnames(rand_cov_17) <- "(Intercept)"

# Residual variance
sd_residual <- 1.2

# Variance list
Var_17 <- list(Subject = rand_cov_17,
               Residual = sd_residual^2)

```

## Simulations - WARNING: TAKES A LONG TIME

```{r, eval=FALSE}

#---- Confirmation before starting Simulations ----
Sim_Confirmation()

Power_Likert_5 <- run_sim(df = df_PS_1,formula = formula,
                          fixef = fixef_15,
                          ranef = rand_cov_15,
                          SESOI = fixef_15_SESOI,
                          fixef_name = c("Condition", "Contrast"),
                          var_name = "Subject", 
                          sub_range = sample_n,
                          sim_n = 1400)

save(Power_Likert_5, file = paste0("Power/Likert_5_", format(Sys.time(), "%Y%m%d-%H%M%S")))

Power_Likert_7 <- run_sim(df = df_A_1,formula = formula,
                          fixef = fixef_17,
                          ranef = rand_cov_17, 
                          SESOI = fixef_17_SESOI,
                          fixef_name = c("Condition", "Contrast"),
                          var_name = "Subject", 
                          sub_range = sample_n,
                          sim_n = 1400)

save(Power_Likert_7, file = paste0("Power/Likert_7_", format(Sys.time(), "%Y%m%d-%H%M%S")))

```

```{r, echo=FALSE}

load("Power/Likert_5_20251201-152710")
load("Power/Likert_7_20251201-154345")

```

# Results

```{r}

multiplotPower(Power_Likert_5, filename = "Power/powerplot_likert_5.png")

```

![Power plot for the Likert 5 models](Power/powerplot_likert_5.png)

```{r}
multiplotPower(Power_Likert_7, filename = "Power/powerplot_likert_7.png")


```

![Power plot for the Likert 7 models](Power/powerplot_likert_7.png)
